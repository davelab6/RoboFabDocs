

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ufoLib.glifLib &mdash; RoboFab 1.3.0a documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.3.0a',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="RoboFab 1.3.0a documentation" href="../../index.html" />
    <link rel="up" title="ufoLib" href="../ufoLib.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">RoboFab 1.3.0a documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ufoLib.html" accesskey="U">ufoLib</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ufoLib.glifLib</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">glifLib.py -- Generic module for reading and writing the .glif format.</span>

<span class="sd">More info about the .glif format (GLyphInterchangeFormat) can be found here:</span>

<span class="sd">	http://unifiedfontobject.org</span>

<span class="sd">The main class in this module is GlyphSet. It manages a set of .glif files</span>
<span class="sd">in a folder. It offers two ways to read glyph data, and one way to write</span>
<span class="sd">glyph data. See the class doc string for details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">xmlTreeBuilder</span> <span class="kn">import</span> <span class="n">buildTree</span><span class="p">,</span> <span class="n">stripCharacterData</span>
<span class="kn">from</span> <span class="nn">ufoLib.pointPen</span> <span class="kn">import</span> <span class="n">AbstractPointPen</span>
<span class="kn">from</span> <span class="nn">plistlib</span> <span class="kn">import</span> <span class="n">readPlist</span><span class="p">,</span> <span class="n">writePlistToString</span>
<span class="kn">from</span> <span class="nn">filenames</span> <span class="kn">import</span> <span class="n">userNameToFileName</span>
<span class="kn">from</span> <span class="nn">validators</span> <span class="kn">import</span> <span class="n">isDictEnough</span><span class="p">,</span> <span class="n">genericTypeValidator</span><span class="p">,</span> <span class="n">colorValidator</span><span class="p">,</span>\
	<span class="n">guidelinesValidator</span><span class="p">,</span> <span class="n">anchorsValidator</span><span class="p">,</span> <span class="n">identifierValidator</span><span class="p">,</span> <span class="n">imageValidator</span><span class="p">,</span> <span class="n">glyphLibValidator</span>

<span class="k">try</span><span class="p">:</span>
	<span class="nb">set</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
	<span class="kn">from</span> <span class="nn">sets</span> <span class="kn">import</span> <span class="n">Set</span> <span class="k">as</span> <span class="nb">set</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
	<span class="s">&quot;GlyphSet&quot;</span><span class="p">,</span>
	<span class="s">&quot;GlifLibError&quot;</span><span class="p">,</span>
	<span class="s">&quot;readGlyphFromString&quot;</span><span class="p">,</span> <span class="s">&quot;writeGlyphToString&quot;</span><span class="p">,</span>
	<span class="s">&quot;glyphNameToFileName&quot;</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">GlifLibError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>


<span class="c"># -------------------------</span>
<span class="c"># Reading and Writing Modes</span>
<span class="c"># -------------------------</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;mac&quot;</span><span class="p">:</span>
	<span class="n">WRITE_MODE</span> <span class="o">=</span> <span class="s">&quot;wb&quot;</span>  <span class="c"># use unix line endings, even with Classic MacPython</span>
	<span class="n">READ_MODE</span> <span class="o">=</span> <span class="s">&quot;rb&quot;</span>
<span class="k">else</span><span class="p">:</span>
	<span class="n">WRITE_MODE</span> <span class="o">=</span> <span class="s">&quot;w&quot;</span>
	<span class="n">READ_MODE</span> <span class="o">=</span> <span class="s">&quot;r&quot;</span>

<span class="c"># ---------</span>
<span class="c"># Constants</span>
<span class="c"># ---------</span>

<span class="n">LAYERINFO_FILENAME</span> <span class="o">=</span> <span class="s">&quot;layerinfo.plist&quot;</span>
<span class="n">supportedUFOFormatVersions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">supportedGLIFFormatVersions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>


<span class="c"># ------------</span>
<span class="c"># Simple Glyph</span>
<span class="c"># ------------</span>

<span class="k">class</span> <span class="nc">Glyph</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Minimal glyph object. It has no glyph attributes until either</span>
<span class="sd">	the draw() or the drawPoint() method has been called.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphSet</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphName</span> <span class="o">=</span> <span class="n">glyphName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphSet</span> <span class="o">=</span> <span class="n">glyphSet</span>

	<span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pen</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Draw this glyph onto a *FontTools* Pen.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="kn">from</span> <span class="nn">robofab.pens.adapterPens</span> <span class="kn">import</span> <span class="n">PointToSegmentPen</span>
		<span class="n">pointPen</span> <span class="o">=</span> <span class="n">PointToSegmentPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">drawPoints</span><span class="p">(</span><span class="n">pointPen</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">drawPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Draw this glyph onto a PointPen.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphSet</span><span class="o">.</span><span class="n">readGlyph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphName</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">)</span>


<span class="c"># ---------</span>
<span class="c"># Glyph Set</span>
<span class="c"># ---------</span>

<div class="viewcode-block" id="GlyphSet"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet">[docs]</a><span class="k">class</span> <span class="nc">GlyphSet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	GlyphSet manages a set of .glif files inside one directory.</span>

<span class="sd">	GlyphSet&#39;s constructor takes a path to an existing directory as it&#39;s</span>
<span class="sd">	first argument. Reading glyph data can either be done through the</span>
<span class="sd">	readGlyph() method, or by using GlyphSet&#39;s dictionary interface, where</span>
<span class="sd">	the keys are glyph names and the values are (very) simple glyph objects.</span>

<span class="sd">	To write a glyph to the glyph set, you use the writeGlyph() method.</span>
<span class="sd">	The simple glyph objects returned through the dict interface do not</span>
<span class="sd">	support writing, they are just a convenient way to get at the glyph data.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">glyphClass</span> <span class="o">=</span> <span class="n">Glyph</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirName</span><span class="p">,</span> <span class="n">glyphNameToFileNameFunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ufoFormatVersion</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		&#39;dirName&#39; should be a path to an existing directory.</span>

<span class="sd">		The optional &#39;glyphNameToFileNameFunc&#39; argument must be a callback</span>
<span class="sd">		function that takes two arguments: a glyph name and the GlyphSet</span>
<span class="sd">		instance. It should return a file name (including the .glif</span>
<span class="sd">		extension). The glyphNameToFileName function is called whenever</span>
<span class="sd">		a file name is created for a given glyph name.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dirName</span> <span class="o">=</span> <span class="n">dirName</span>
		<span class="k">if</span> <span class="n">ufoFormatVersion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supportedUFOFormatVersions</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unsupported UFO format version: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ufoFormatVersion</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">=</span> <span class="n">ufoFormatVersion</span>
		<span class="k">if</span> <span class="n">glyphNameToFileNameFunc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">glyphNameToFileNameFunc</span> <span class="o">=</span> <span class="n">glyphNameToFileName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphNameToFileName</span> <span class="o">=</span> <span class="n">glyphNameToFileNameFunc</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rebuildContents</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_glifCache</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="GlyphSet.rebuildContents"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.rebuildContents">[docs]</a>	<span class="k">def</span> <span class="nf">rebuildContents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Rebuild the contents dict by loading contents.plist.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">contentsPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="s">&quot;contents.plist&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">contentsPath</span><span class="p">):</span>
			<span class="c"># missing, consider the glyphset empty.</span>
			<span class="n">contents</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readPlist</span><span class="p">(</span><span class="n">contentsPath</span><span class="p">)</span>
		<span class="c"># validate the contents</span>
		<span class="n">invalidFormat</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="n">invalidFormat</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
					<span class="n">invalidFormat</span> <span class="o">=</span> <span class="bp">True</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
					<span class="n">invalidFormat</span> <span class="o">=</span> <span class="bp">True</span>
				<span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)):</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;contents.plist references a file that does not exist: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">invalidFormat</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;contents.plist is not properly formatted&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="GlyphSet.getReverseContents"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.getReverseContents">[docs]</a>	<span class="k">def</span> <span class="nf">getReverseContents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a reversed dict of self.contents, mapping file names to</span>
<span class="sd">		glyph names. This is primarily an aid for custom glyph name to file</span>
<span class="sd">		name schemes that want to make sure they don&#39;t generate duplicate</span>
<span class="sd">		file names. The file names are converted to lowercase so we can</span>
<span class="sd">		reliably check for duplicates that only differ in case, which is</span>
<span class="sd">		important for case-insensitive file systems.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
				<span class="n">d</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">k</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="o">=</span> <span class="n">d</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span>
</div>
<div class="viewcode-block" id="GlyphSet.writeContents"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.writeContents">[docs]</a>	<span class="k">def</span> <span class="nf">writeContents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Write the contents.plist file out to disk. Call this method when</span>
<span class="sd">		you&#39;re done writing glyphs.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">contentsPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="s">&quot;contents.plist&quot;</span><span class="p">)</span>
		<span class="c"># We need to force Unix line endings, even in OS9 MacPython in FL,</span>
		<span class="c"># so we do the writing to file ourselves.</span>
		<span class="n">plist</span> <span class="o">=</span> <span class="n">writePlistToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">contentsPath</span><span class="p">,</span> <span class="n">WRITE_MODE</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="c"># layer info</span>
</div>
	<span class="k">def</span> <span class="nf">readLayerInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="n">LAYERINFO_FILENAME</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
			<span class="k">return</span>
		<span class="n">infoDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readPlist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">infoDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;layerinfo.plist is not properly formatted.&quot;</span><span class="p">)</span>
		<span class="n">infoDict</span> <span class="o">=</span> <span class="n">validateLayerInfoVersion3Data</span><span class="p">(</span><span class="n">infoDict</span><span class="p">)</span>
		<span class="c"># populate the object</span>
		<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">infoDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="nb">setattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The supplied layer info object does not support setting a necessary attribute (</span><span class="si">%s</span><span class="s">).&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">writeLayerInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;layerinfo.plist is not allowed in UFO </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span><span class="p">)</span>
		<span class="c"># gather data</span>
		<span class="n">infoData</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">layerInfoVersion3ValueData</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The supplied info object does not support getting a necessary attribute (</span><span class="si">%s</span><span class="s">).&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">infoData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="c"># validate</span>
		<span class="n">infoData</span> <span class="o">=</span> <span class="n">validateLayerInfoVersion3Data</span><span class="p">(</span><span class="n">infoData</span><span class="p">)</span>
		<span class="c"># write file</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="n">LAYERINFO_FILENAME</span><span class="p">)</span>
		<span class="n">plist</span> <span class="o">=</span> <span class="n">writePlistToString</span><span class="p">(</span><span class="n">infoData</span><span class="p">)</span>
		<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">WRITE_MODE</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="c"># read caching</span>

<div class="viewcode-block" id="GlyphSet.getGLIF"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.getGLIF">[docs]</a>	<span class="k">def</span> <span class="nf">getGLIF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the raw GLIF text for a given glyph name. This only works</span>
<span class="sd">		for GLIF files that are already on disk.</span>

<span class="sd">		This method is useful in situations when the raw XML needs to be</span>
<span class="sd">		read from a glyph set for a particular glyph before fully parsing</span>
<span class="sd">		it into an object structure via the readGlyph method.</span>

<span class="sd">		Internally, this method will load a GLIF the first time it is</span>
<span class="sd">		called and then cache it. The next time this method is called</span>
<span class="sd">		the GLIF will be pulled from the cache if the file&#39;s modification</span>
<span class="sd">		time has not changed since the GLIF was cached. For memory</span>
<span class="sd">		efficiency, the cached GLIF will be purged by various other methods</span>
<span class="sd">		such as readGlyph.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">needRead</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">glyphName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_glifCache</span><span class="p">:</span>
			<span class="n">needRead</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">elif</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_glifCache</span><span class="p">[</span><span class="n">glyphName</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
			<span class="n">needRead</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="k">if</span> <span class="n">needRead</span><span class="p">:</span>
			<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">glyphName</span>
			<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
			<span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_glifCache</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_glifCache</span><span class="p">[</span><span class="n">glyphName</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</div>
	<span class="k">def</span> <span class="nf">_purgeCachedGLIF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_glifCache</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_glifCache</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>

	<span class="c"># reading/writing API</span>

<div class="viewcode-block" id="GlyphSet.readGlyph"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.readGlyph">[docs]</a>	<span class="k">def</span> <span class="nf">readGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Read a .glif file for &#39;glyphName&#39; from the glyph set. The</span>
<span class="sd">		&#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">		the readGlyph() method will attempt to set the following</span>
<span class="sd">		attributes on it:</span>
<span class="sd">			&quot;width&quot;      the advance with of the glyph</span>
<span class="sd">			&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">			&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">			&quot;note&quot;       a string</span>
<span class="sd">			&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">			&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">			&quot;guidelines&quot; a list of guideline data dictionaries</span>

<span class="sd">		All attributes are optional, in two ways:</span>
<span class="sd">			1) An attribute *won&#39;t* be set if the .glif file doesn&#39;t</span>
<span class="sd">			   contain data for it. &#39;glyphObject&#39; will have to deal</span>
<span class="sd">			   with default values itself.</span>
<span class="sd">			2) If setting the attribute fails with an AttributeError</span>
<span class="sd">			   (for example if the &#39;glyphObject&#39; attribute is read-</span>
<span class="sd">			   only), readGlyph() will not propagate that exception,</span>
<span class="sd">			   but ignore that attribute.</span>

<span class="sd">		To retrieve outline information, you need to pass an object</span>
<span class="sd">		conforming to the PointPen protocol as the &#39;pointPen&#39; argument.</span>
<span class="sd">		This argument may be None if you don&#39;t need the outline data.</span>

<span class="sd">		readGlyph() will raise KeyError if the glyph is not present in</span>
<span class="sd">		the glyph set.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_purgeCachedGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="n">tree</span> <span class="o">=</span> <span class="n">_glifTreeFromFile</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
			<span class="n">formatVersions</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">formatVersions</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">_readGlyphFromTree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">,</span> <span class="n">formatVersions</span><span class="o">=</span><span class="n">formatVersions</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="GlyphSet.writeGlyph"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.writeGlyph">[docs]</a>	<span class="k">def</span> <span class="nf">writeGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">drawPointsFunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">formatVersion</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Write a .glif file for &#39;glyphName&#39; to the glyph set. The</span>
<span class="sd">		&#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">		the writeGlyph() method will attempt to get the following</span>
<span class="sd">		attributes from it:</span>
<span class="sd">			&quot;width&quot;      the advance with of the glyph</span>
<span class="sd">			&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">			&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">			&quot;note&quot;       a string</span>
<span class="sd">			&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">			&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">			&quot;guidelines&quot; a list of guideline data dictionaries</span>

<span class="sd">		All attributes are optional: if &#39;glyphObject&#39; doesn&#39;t</span>
<span class="sd">		have the attribute, it will simply be skipped.</span>

<span class="sd">		To write outline data to the .glif file, writeGlyph() needs</span>
<span class="sd">		a function (any callable object actually) that will take one</span>
<span class="sd">		argument: an object that conforms to the PointPen protocol.</span>
<span class="sd">		The function will be called by writeGlyph(); it has to call the</span>
<span class="sd">		proper PointPen methods to transfer the outline to the .glif file.</span>

<span class="sd">		The GLIF format version will be chosen based on the ufoFormatVersion</span>
<span class="sd">		passed during the creation of this object. If a particular format</span>
<span class="sd">		version is desired, it can be passed with the formatVersion argument.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">formatVersion</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
				<span class="n">formatVersion</span> <span class="o">=</span> <span class="mi">2</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">formatVersion</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">formatVersion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supportedGLIFFormatVersions</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unsupported GLIF format version: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">formatVersion</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unsupported GLIF format version (</span><span class="si">%d</span><span class="s">) for UFO format version </span><span class="si">%d</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">formatVersion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_purgeCachedGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">writeGlyphToString</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="p">,</span> <span class="n">drawPointsFunc</span><span class="p">,</span> <span class="n">formatVersion</span><span class="o">=</span><span class="n">formatVersion</span><span class="p">)</span>
		<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphNameToFileName</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileName</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span><span class="p">[</span><span class="n">fileName</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">glyphName</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
			<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">READ_MODE</span><span class="p">)</span>
			<span class="n">oldData</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
			<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="n">oldData</span><span class="p">:</span>
				<span class="k">return</span>
		<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">WRITE_MODE</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="GlyphSet.deleteGlyph"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.deleteGlyph">[docs]</a>	<span class="k">def</span> <span class="nf">deleteGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Permanently delete the glyph from the glyph set on disk. Will</span>
<span class="sd">		raise KeyError if the glyph is not present in the glyph set.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_purgeCachedGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
		<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">))</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>

	<span class="c"># dict-like support</span>
</div>
	<span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span>

	<span class="n">__contains__</span> <span class="o">=</span> <span class="n">has_key</span>

	<span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">glyphName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">glyphName</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphClass</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

	<span class="c"># quickly fetch unicode values</span>

<div class="viewcode-block" id="GlyphSet.getUnicodes"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.getUnicodes">[docs]</a>	<span class="k">def</span> <span class="nf">getUnicodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphNames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a dictionary that maps glyph names to lists containing</span>
<span class="sd">		the unicode value[s] for that glyph, if any. This parses the .glif</span>
<span class="sd">		files partially, so it is a lot faster than parsing all files completely.</span>
<span class="sd">		By default this checks all glyphs, but a subset can be passed with glyphNames.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">unicodes</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">glyphNames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">glyphNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyphNames</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
			<span class="n">unicodes</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fetchUnicodes</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">unicodes</span>
</div>
<div class="viewcode-block" id="GlyphSet.getComponentReferences"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.getComponentReferences">[docs]</a>	<span class="k">def</span> <span class="nf">getComponentReferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphNames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a dictionary that maps glyph names to lists containing the</span>
<span class="sd">		base glyph name of components in the glyph. This parses the .glif</span>
<span class="sd">		files partially, so it is a lot faster than parsing all files completely.</span>
<span class="sd">		By default this checks all glyphs, but a subset can be passed with glyphNames.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">glyphNames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">glyphNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyphNames</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
			<span class="n">components</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fetchComponentBases</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">components</span>
</div>
<div class="viewcode-block" id="GlyphSet.getImageReferences"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.GlyphSet.getImageReferences">[docs]</a>	<span class="k">def</span> <span class="nf">getImageReferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphNames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a dictionary that maps glyph names to the file name of the image</span>
<span class="sd">		referenced by the glyph. This parses the .glif files partially, so it is a</span>
<span class="sd">		lot faster than parsing all files completely.</span>
<span class="sd">		By default this checks all glyphs, but a subset can be passed with glyphNames.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">images</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">glyphNames</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">glyphNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyphNames</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
			<span class="n">images</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fetchImageFileName</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">images</span>

	<span class="c"># internal methods</span>
</div>
	<span class="k">def</span> <span class="nf">_readPlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">readPlist</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">data</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The file </span><span class="si">%s</span><span class="s"> could not be read.&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>


<span class="c"># -----------------------</span>
<span class="c"># Glyph Name to File Name</span>
<span class="c"># -----------------------</span>
</div>
<div class="viewcode-block" id="glyphNameToFileName"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.glyphNameToFileName">[docs]</a><span class="k">def</span> <span class="nf">glyphNameToFileName</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphSet</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Wrapper around the userNameToFileName function in filenames.py</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">glyphSet</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">new</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
			<span class="n">glyphName</span> <span class="o">=</span> <span class="n">new</span>
		<span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
			<span class="k">pass</span>
	<span class="k">return</span> <span class="n">userNameToFileName</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="n">existing</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s">&quot;.glif&quot;</span><span class="p">)</span>

<span class="c"># -----------------------</span>
<span class="c"># GLIF To and From String</span>
<span class="c"># -----------------------</span>
</div>
<div class="viewcode-block" id="readGlyphFromString"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.readGlyphFromString">[docs]</a><span class="k">def</span> <span class="nf">readGlyphFromString</span><span class="p">(</span><span class="n">aString</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">formatVersions</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Read .glif data from a string into a glyph object.</span>

<span class="sd">	The &#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">	the readGlyphFromString() method will attempt to set the following</span>
<span class="sd">	attributes on it:</span>
<span class="sd">		&quot;width&quot;      the advance with of the glyph</span>
<span class="sd">		&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">		&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">		&quot;note&quot;       a string</span>
<span class="sd">		&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">		&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">		&quot;guidelines&quot; a list of guideline data dictionaries</span>
<span class="sd">		&quot;anchors&quot;    a list of anchor data dictionaries</span>

<span class="sd">	All attributes are optional, in two ways:</span>
<span class="sd">		1) An attribute *won&#39;t* be set if the .glif file doesn&#39;t</span>
<span class="sd">		   contain data for it. &#39;glyphObject&#39; will have to deal</span>
<span class="sd">		   with default values itself.</span>
<span class="sd">		2) If setting the attribute fails with an AttributeError</span>
<span class="sd">		   (for example if the &#39;glyphObject&#39; attribute is read-</span>
<span class="sd">		   only), readGlyphFromString() will not propagate that</span>
<span class="sd">		   exception, but ignore that attribute.</span>

<span class="sd">	To retrieve outline information, you need to pass an object</span>
<span class="sd">	conforming to the PointPen protocol as the &#39;pointPen&#39; argument.</span>
<span class="sd">	This argument may be None if you don&#39;t need the outline data.</span>

<span class="sd">	The formatVersions argument defined the GLIF format versions</span>
<span class="sd">	that are allowed to be read.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">tree</span> <span class="o">=</span> <span class="n">_glifTreeFromFile</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">aString</span><span class="p">))</span>
	<span class="n">_readGlyphFromTree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="writeGlyphToString"><a class="viewcode-back" href="../../ufoLib/glifLib.html#ufoLib.glifLib.writeGlyphToString">[docs]</a><span class="k">def</span> <span class="nf">writeGlyphToString</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">drawPointsFunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">formatVersion</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Return .glif data for a glyph as a UTF-8 encoded string.</span>
<span class="sd">	The &#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">	the writeGlyphToString() method will attempt to get the following</span>
<span class="sd">	attributes from it:</span>
<span class="sd">		&quot;width&quot;      the advance width of the glyph</span>
<span class="sd">		&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">		&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">		&quot;note&quot;       a string</span>
<span class="sd">		&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">		&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">		&quot;guidelines&quot; a list of guideline data dictionaries</span>
<span class="sd">		&quot;anchors&quot;    a list of anchor data dictionaries</span>

<span class="sd">	All attributes are optional: if &#39;glyphObject&#39; doesn&#39;t</span>
<span class="sd">	have the attribute, it will simply be skipped.</span>

<span class="sd">	To write outline data to the .glif file, writeGlyphToString() needs</span>
<span class="sd">	a function (any callable object actually) that will take one</span>
<span class="sd">	argument: an object that conforms to the PointPen protocol.</span>
<span class="sd">	The function will be called by writeGlyphToString(); it has to call the</span>
<span class="sd">	proper PointPen methods to transfer the outline to the .glif file.</span>

<span class="sd">	The GLIF format version can be specified with the formatVersion argument.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">writer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="kn">from</span> <span class="nn">xmlWriter</span> <span class="kn">import</span> <span class="n">XMLWriter</span>
		<span class="n">aFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
		<span class="n">writer</span> <span class="o">=</span> <span class="n">XMLWriter</span><span class="p">(</span><span class="n">aFile</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">aFile</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
	<span class="c"># start</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The glyph name is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The glyph name is empty.&quot;</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">begintag</span><span class="p">(</span><span class="s">&quot;glyph&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;format&quot;</span><span class="p">,</span> <span class="n">formatVersion</span><span class="p">)])</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="c"># advance</span>
	<span class="n">_writeAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
	<span class="c"># unicodes</span>
	<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;unicodes&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
		<span class="n">_writeUnicodes</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
	<span class="c"># note</span>
	<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;note&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
		<span class="n">_writeNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
	<span class="c"># image</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
		<span class="n">_writeImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
	<span class="c"># guidelines</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;guidelines&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
		<span class="n">_writeGuidelines</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">)</span>
	<span class="c"># anchors</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;anchors&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="n">_writeAnchors</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">)</span>
	<span class="c"># outline</span>
	<span class="k">if</span> <span class="n">drawPointsFunc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">begintag</span><span class="p">(</span><span class="s">&quot;outline&quot;</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
		<span class="n">pen</span> <span class="o">=</span> <span class="n">GLIFPointPen</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">identifiers</span><span class="o">=</span><span class="n">identifiers</span><span class="p">)</span>
		<span class="n">drawPointsFunc</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">anchors</span><span class="p">:</span>
			<span class="n">_writeAnchorsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">endtag</span><span class="p">(</span><span class="s">&quot;outline&quot;</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="c"># lib</span>
	<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;lib&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
		<span class="n">_writeLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
	<span class="c"># end</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">endtag</span><span class="p">(</span><span class="s">&quot;glyph&quot;</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="c"># return the appropriate value</span>
	<span class="k">if</span> <span class="n">aFile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">aFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">None</span>
</div>
<span class="k">def</span> <span class="nf">_writeAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
	<span class="n">width</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;width attribute must be int or float&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		    <span class="n">width</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="n">height</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;height&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;height attribute must be int or float&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		    <span class="n">height</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;advance&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">),</span> <span class="n">height</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="k">elif</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;advance&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="k">elif</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;advance&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeUnicodes</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
	<span class="n">unicodes</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;unicodes&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unicodes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
		<span class="n">unicodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">unicodes</span><span class="p">]</span>
	<span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">unicodes</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;unicode values must be int&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
			<span class="k">continue</span>
		<span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
		<span class="n">hexCode</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">code</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hexCode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
			<span class="n">hexCode</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">hexCode</span><span class="p">))</span> <span class="o">+</span> <span class="n">hexCode</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;unicode&quot;</span><span class="p">,</span> <span class="nb">hex</span><span class="o">=</span><span class="n">hexCode</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
	<span class="n">note</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;note&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;note attribute must be str or unicode&quot;</span><span class="p">)</span>
	<span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">begintag</span><span class="p">(</span><span class="s">&quot;note&quot;</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">note</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">endtag</span><span class="p">(</span><span class="s">&quot;note&quot;</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
	<span class="n">image</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">imageValidator</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;image attribute must be a dict or dict-like object with the proper structure.&quot;</span><span class="p">)</span>
	<span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span>
		<span class="p">(</span><span class="s">&quot;fileName&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">])</span>
	<span class="p">]</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">default</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
	<span class="n">color</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;color&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;image&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeGuidelines</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
	<span class="n">guidelines</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;guidelines&quot;</span><span class="p">,</span> <span class="p">[])</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">guidelinesValidator</span><span class="p">(</span><span class="n">guidelines</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;guidelines attribute does not have the proper structure.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">guideline</span> <span class="ow">in</span> <span class="n">guidelines</span><span class="p">:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
		<span class="n">angle</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;angle&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;angle&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">angle</span><span class="p">)))</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;color&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>
		<span class="n">identifier</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;identifier&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;identifier&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">))</span>
			<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;guideline&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeAnchorsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">anchors</span><span class="p">):</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;anchors attribute does not have the proper structure.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">()</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="s">&quot;move&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">endPath</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeAnchors</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;anchors&quot;</span><span class="p">,</span> <span class="p">[])</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;anchors attribute does not have the proper structure.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;color&quot;</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>
		<span class="n">identifier</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;identifier&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;identifier&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">))</span>
			<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;anchor&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
	<span class="kn">from</span> <span class="nn">ufoLib.plistlib</span> <span class="kn">import</span> <span class="n">PlistWriter</span>
	<span class="n">lib</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;lib&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">isDictEnough</span><span class="p">(</span><span class="n">lib</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;lib attribute must be a dict.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
	    <span class="n">lib</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">begintag</span><span class="p">(</span><span class="s">&quot;lib&quot;</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
	<span class="n">plistWriter</span> <span class="o">=</span> <span class="n">PlistWriter</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">indentLevel</span><span class="o">=</span><span class="n">writer</span><span class="o">.</span><span class="n">indentlevel</span><span class="p">,</span>
			<span class="n">indent</span><span class="o">=</span><span class="n">writer</span><span class="o">.</span><span class="n">indentwhite</span><span class="p">,</span> <span class="n">writeHeader</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="n">plistWriter</span><span class="o">.</span><span class="n">writeValue</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">endtag</span><span class="p">(</span><span class="s">&quot;lib&quot;</span><span class="p">)</span>
	<span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="c"># -----------------------</span>
<span class="c"># layerinfo.plist Support</span>
<span class="c"># -----------------------</span>

<span class="n">layerInfoVersion3ValueData</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;color&quot;</span>			<span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span><span class="p">,</span> <span class="n">valueValidator</span><span class="o">=</span><span class="n">colorValidator</span><span class="p">),</span>
	<span class="s">&quot;lib&quot;</span>			<span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">valueValidator</span><span class="o">=</span><span class="n">genericTypeValidator</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">validateLayerInfoVersion3ValueForAttribute</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	This performs very basic validation of the value for attribute</span>
<span class="sd">	following the UFO 3 fontinfo.plist specification. The results</span>
<span class="sd">	of this should not be interpretted as *correct* for the font</span>
<span class="sd">	that they are part of. This merely indicates that the value</span>
<span class="sd">	is of the proper type and, where the specification defines</span>
<span class="sd">	a set range of possible values for an attribute, that the</span>
<span class="sd">	value is in the accepted range.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layerInfoVersion3ValueData</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">False</span>
	<span class="n">dataValidationDict</span> <span class="o">=</span> <span class="n">layerInfoVersion3ValueData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
	<span class="n">valueType</span> <span class="o">=</span> <span class="n">dataValidationDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span>
	<span class="n">validator</span> <span class="o">=</span> <span class="n">dataValidationDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;valueValidator&quot;</span><span class="p">)</span>
	<span class="n">valueOptions</span> <span class="o">=</span> <span class="n">dataValidationDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;valueOptions&quot;</span><span class="p">)</span>
	<span class="c"># have specific options for the validator</span>
	<span class="k">if</span> <span class="n">valueOptions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">valueOptions</span><span class="p">)</span>
	<span class="c"># no specific options</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validator</span> <span class="o">==</span> <span class="n">genericTypeValidator</span><span class="p">:</span>
			<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">valueType</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">isValidValue</span>

<span class="k">def</span> <span class="nf">validateLayerInfoVersion3Data</span><span class="p">(</span><span class="n">infoData</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	This performs very basic validation of the value for infoData</span>
<span class="sd">	following the UFO 3 layerinfo.plist specification. The results</span>
<span class="sd">	of this should not be interpretted as *correct* for the font</span>
<span class="sd">	that they are part of. This merely indicates that the values</span>
<span class="sd">	are of the proper type and, where the specification defines</span>
<span class="sd">	a set range of possible values for an attribute, that the</span>
<span class="sd">	value is in the accepted range.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">validInfoData</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">infoData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layerInfoVersion3ValueData</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown attribute </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
		<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validateLayerInfoVersion3ValueForAttribute</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">isValidValue</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Invalid value for attribute </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">validInfoData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
	<span class="k">return</span> <span class="n">validInfoData</span>

<span class="c"># -----------------</span>
<span class="c"># GLIF Tree Support</span>
<span class="c"># -----------------</span>

<span class="k">def</span> <span class="nf">_stripGlyphXMLTree</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Invalid GLIF structure.&quot;</span><span class="p">)</span>
		<span class="n">element</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">node</span>
		<span class="c"># &quot;lib&quot; is formatted as a plist, so we need unstripped</span>
		<span class="c"># character data so we can support strings with leading or</span>
		<span class="c"># trailing whitespace. Do strip everything else.</span>
		<span class="n">recursive</span> <span class="o">=</span> <span class="p">(</span><span class="n">element</span> <span class="o">!=</span> <span class="s">&quot;lib&quot;</span><span class="p">)</span>
		<span class="n">stripCharacterData</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_glifTreeFromFile</span><span class="p">(</span><span class="n">aFile</span><span class="p">):</span>
	<span class="n">tree</span> <span class="o">=</span> <span class="n">buildTree</span><span class="p">(</span><span class="n">aFile</span><span class="p">,</span> <span class="n">stripData</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="n">stripCharacterData</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;glyph&quot;</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The GLIF is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="n">_stripGlyphXMLTree</span><span class="p">(</span><span class="n">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
	<span class="k">return</span> <span class="n">tree</span>

<span class="k">def</span> <span class="nf">_readGlyphFromTree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">formatVersions</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
	<span class="c"># quick format validation</span>
	<span class="n">formatError</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
		<span class="n">formatError</span> <span class="o">=</span> <span class="bp">True</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;glyph&quot;</span><span class="p">:</span>
			<span class="n">formatError</span> <span class="o">=</span> <span class="bp">True</span>
	<span class="k">if</span> <span class="n">formatError</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;GLIF data is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="c"># check the format version</span>
	<span class="n">formatVersion</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;format&quot;</span><span class="p">,</span> <span class="s">&quot;undefined&quot;</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">formatVersion</span><span class="p">)</span>
		<span class="n">formatVersion</span> <span class="o">=</span> <span class="n">v</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">_readGlyphFromTreeFormat1</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="n">pointPen</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
		<span class="n">_readGlyphFromTreeFormat2</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="n">pointPen</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unsupported GLIF format version: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">formatVersion</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_readGlyphFromTreeFormat1</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="c"># get the name</span>
	<span class="n">_readName</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="c"># populate the sub elements</span>
	<span class="n">unicodes</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="n">haveSeenLib</span> <span class="o">=</span> <span class="n">haveSeenNote</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
		<span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;outline&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenOutline</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The outline element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The outline element contains unknown attributes.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="k">if</span> <span class="n">pointPen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">buildOutlineFormat1</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">continue</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;advance&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenAdvance</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The advance element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="n">_readAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;unicode&quot;</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">,</span> <span class="s">&quot;undefined&quot;</span><span class="p">)</span>
				<span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unicodes</span><span class="p">:</span>
					<span class="n">unicodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Illegal value for hex attribute of unicode element.&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;note&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenNote</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The note element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenNote</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="n">_readNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;lib&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenLib</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The lib element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenLib</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="n">_readLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown element in GLIF: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
	<span class="c"># set the collected unicodes</span>
	<span class="k">if</span> <span class="n">unicodes</span><span class="p">:</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;unicodes&quot;</span><span class="p">,</span> <span class="n">unicodes</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readGlyphFromTreeFormat2</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
	<span class="c"># get the name</span>
	<span class="n">_readName</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="c"># populate the sub elements</span>
	<span class="n">unicodes</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">guidelines</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="n">haveSeenImage</span> <span class="o">=</span> <span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="n">haveSeenLib</span> <span class="o">=</span> <span class="n">haveSeenNote</span> <span class="o">=</span> <span class="bp">False</span>
	<span class="n">identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
		<span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;outline&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenOutline</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The outline element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The outline element contains unknown attributes.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="k">if</span> <span class="n">pointPen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="n">buildOutlineFormat2</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">continue</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;advance&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenAdvance</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The advance element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="n">_readAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;unicode&quot;</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">,</span> <span class="s">&quot;undefined&quot;</span><span class="p">)</span>
				<span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unicodes</span><span class="p">:</span>
					<span class="n">unicodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Illegal value for hex attribute of unicode element.&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;guideline&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown children in guideline element.&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;angle&quot;</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
					<span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
			<span class="n">guidelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;anchor&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown children in anchor element.&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
					<span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
			<span class="n">anchors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;image&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenImage</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The image element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown children in image element.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenImage</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="n">_readImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;note&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenNote</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The note element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenNote</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="n">_readNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;lib&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">haveSeenLib</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The lib element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenLib</span> <span class="o">=</span> <span class="bp">True</span>
			<span class="n">_readLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown element in GLIF: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
	<span class="c"># set the collected unicodes</span>
	<span class="k">if</span> <span class="n">unicodes</span><span class="p">:</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;unicodes&quot;</span><span class="p">,</span> <span class="n">unicodes</span><span class="p">)</span>
	<span class="c"># set the collected guidelines</span>
	<span class="k">if</span> <span class="n">guidelines</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">guidelinesValidator</span><span class="p">(</span><span class="n">guidelines</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The guidelines are improperly formatted.&quot;</span><span class="p">)</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;guidelines&quot;</span><span class="p">,</span> <span class="n">guidelines</span><span class="p">)</span>
	<span class="c"># set the collected anchors</span>
	<span class="k">if</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The anchors are improperly formatted.&quot;</span><span class="p">)</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;anchors&quot;</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readName</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
	<span class="n">glyphName</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">glyphName</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Empty glyph name in GLIF.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">glyphName</span> <span class="ow">and</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;height&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;height&quot;</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
	<span class="n">rawNote</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
	<span class="n">lines</span> <span class="o">=</span> <span class="n">rawNote</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
	<span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
	<span class="n">note</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;note&quot;</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
	<span class="kn">from</span> <span class="nn">plistFromTree</span> <span class="kn">import</span> <span class="n">readPlistFromTree</span>
	<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
	<span class="n">lib</span> <span class="o">=</span> <span class="n">readPlistFromTree</span><span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="n">valid</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">glyphLibValidator</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;lib&quot;</span><span class="p">,</span> <span class="n">lib</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
	<span class="n">imageData</span> <span class="o">=</span> <span class="n">attrs</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
		<span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">imageData</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">imageData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
		<span class="n">imageData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">imageValidator</span><span class="p">(</span><span class="n">imageData</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The image element is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">,</span> <span class="n">imageData</span><span class="p">)</span>

<span class="c"># ----------------</span>
<span class="c"># GLIF to PointPen</span>
<span class="c"># ----------------</span>

<span class="n">contourAttributesFormat2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;identifier&quot;</span><span class="p">])</span>
<span class="n">componentAttributesFormat1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;base&quot;</span><span class="p">,</span> <span class="s">&quot;xScale&quot;</span><span class="p">,</span> <span class="s">&quot;xyScale&quot;</span><span class="p">,</span> <span class="s">&quot;yxScale&quot;</span><span class="p">,</span> <span class="s">&quot;yScale&quot;</span><span class="p">,</span> <span class="s">&quot;xOffset&quot;</span><span class="p">,</span> <span class="s">&quot;yOffset&quot;</span><span class="p">])</span>
<span class="n">componentAttributesFormat2</span> <span class="o">=</span> <span class="n">componentAttributesFormat1</span> <span class="o">|</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;identifier&quot;</span><span class="p">])</span>
<span class="n">pointAttributesFormat1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="s">&quot;smooth&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">])</span>
<span class="n">pointAttributesFormat2</span> <span class="o">=</span> <span class="n">pointAttributesFormat1</span> <span class="o">|</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;identifier&quot;</span><span class="p">])</span>
<span class="n">pointSmoothOptions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">))</span>
<span class="n">pointTypeOptions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;move&quot;</span><span class="p">,</span> <span class="s">&quot;line&quot;</span><span class="p">,</span> <span class="s">&quot;offcurve&quot;</span><span class="p">,</span> <span class="s">&quot;curve&quot;</span><span class="p">,</span> <span class="s">&quot;qcurve&quot;</span><span class="p">])</span>

<span class="c"># format 1</span>

<span class="n">componentAttributesFormat1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;base&quot;</span><span class="p">,</span> <span class="s">&quot;xScale&quot;</span><span class="p">,</span> <span class="s">&quot;xyScale&quot;</span><span class="p">,</span> <span class="s">&quot;yxScale&quot;</span><span class="p">,</span> <span class="s">&quot;yScale&quot;</span><span class="p">,</span> <span class="s">&quot;xOffset&quot;</span><span class="p">,</span> <span class="s">&quot;yOffset&quot;</span><span class="p">])</span>
<span class="n">pointAttributesFormat1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="s">&quot;smooth&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">])</span>
<span class="n">pointSmoothOptions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">))</span>
<span class="n">pointTypeOptions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;move&quot;</span><span class="p">,</span> <span class="s">&quot;line&quot;</span><span class="p">,</span> <span class="s">&quot;offcurve&quot;</span><span class="p">,</span> <span class="s">&quot;curve&quot;</span><span class="p">,</span> <span class="s">&quot;qcurve&quot;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">buildOutlineFormat1</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pen</span><span class="p">,</span> <span class="n">xmlNodes</span><span class="p">):</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">xmlNodes</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The outline element is not properly structured.&quot;</span><span class="p">)</span>
		<span class="n">element</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">node</span>
		<span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;contour&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">child</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The outline element is not properly structured.&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">child</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;point&quot;</span><span class="p">:</span>
					<span class="n">anchor</span> <span class="o">=</span> <span class="n">_buildAnchorFormat1</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
					<span class="k">if</span> <span class="n">anchor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
						<span class="n">anchors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
						<span class="k">continue</span>
			<span class="n">_buildOutlineContourFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">))</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;component&quot;</span><span class="p">:</span>
			<span class="n">_buildOutlineComponentFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown element in outline element: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;GLIF 1 anchors are not properly formatted.&quot;</span><span class="p">)</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s">&quot;anchors&quot;</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildAnchorFormat1</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;move&quot;</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">None</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Required x attribute is missing in point element.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Required y attribute is missing in point element.&quot;</span><span class="p">)</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
	<span class="n">anchor</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">anchor</span>

<span class="k">def</span> <span class="nf">_buildOutlineContourFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">)):</span>
	<span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown attributes in contour element.&quot;</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">children</span><span class="p">:</span>
		<span class="n">children</span> <span class="o">=</span> <span class="n">_validateAndMassagePointStructures</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">pointAttributesFormat1</span><span class="p">,</span> <span class="n">openContourOffCurveLeniency</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="n">_buildOutlinePointsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">endPath</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_buildOutlinePointsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">subElement</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">segmentType</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;segmentType&quot;</span><span class="p">]</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;smooth&quot;</span><span class="p">]</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="n">segmentType</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildOutlineComponentFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">)):</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown child elements of component element.&quot;</span> <span class="o">%</span> <span class="n">subElement</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">componentAttributesFormat1</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown attributes in component element.&quot;</span><span class="p">)</span>
	<span class="n">baseGlyphName</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;base&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">baseGlyphName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The base attribute is not defined in the component.&quot;</span><span class="p">)</span>
	<span class="n">transformation</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">transformation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">baseGlyphName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">transformation</span><span class="p">))</span>

<span class="c"># format 2</span>

<span class="k">def</span> <span class="nf">buildOutlineFormat2</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pen</span><span class="p">,</span> <span class="n">xmlNodes</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">xmlNodes</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The outline element is not properly structured.&quot;</span><span class="p">)</span>
		<span class="n">element</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">children</span> <span class="o">=</span> <span class="n">node</span>
		<span class="k">if</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;contour&quot;</span><span class="p">:</span>
			<span class="n">_buildOutlineContourFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">),</span> <span class="n">identifiers</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span> <span class="o">==</span> <span class="s">&quot;component&quot;</span><span class="p">:</span>
			<span class="n">_buildOutlineComponentFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">),</span> <span class="n">identifiers</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown element in outline element: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildOutlineContourFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">),</span> <span class="n">identifiers</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">contourAttributesFormat2</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown attributes in contour element.&quot;</span><span class="p">)</span>
	<span class="n">identifier</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;identifier&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The identifier </span><span class="si">%s</span><span class="s"> is used more than once.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The contour identifier </span><span class="si">%s</span><span class="s"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
		<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">()</span>
		<span class="k">raise</span> <span class="n">warn</span><span class="p">(</span><span class="s">&quot;The beginPath method needs an identifier kwarg. The contour&#39;s identifier value has been discarded.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">children</span><span class="p">:</span>
		<span class="n">children</span> <span class="o">=</span> <span class="n">_validateAndMassagePointStructures</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">pointAttributesFormat2</span><span class="p">)</span>
		<span class="n">_buildOutlinePointsFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">endPath</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_buildOutlinePointsFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">subElement</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">segmentType</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;segmentType&quot;</span><span class="p">]</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;smooth&quot;</span><span class="p">]</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span>
		<span class="n">identifier</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;identifier&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The identifier </span><span class="si">%s</span><span class="s"> is used more than once.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The identifier </span><span class="si">%s</span><span class="s"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="n">segmentType</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
			<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="n">segmentType</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">warn</span><span class="p">(</span><span class="s">&quot;The addPoint method needs an identifier kwarg. The point&#39;s identifier value has been discarded.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildOutlineComponentFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">children</span><span class="p">),</span> <span class="n">identifiers</span><span class="p">):</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown child elements of component element.&quot;</span> <span class="o">%</span> <span class="n">subElement</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">componentAttributesFormat2</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown attributes in component element.&quot;</span><span class="p">)</span>
	<span class="n">baseGlyphName</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;base&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">baseGlyphName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The base attribute is not defined in the component.&quot;</span><span class="p">)</span>
	<span class="n">transformation</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">transformation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="n">identifier</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;identifier&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The identifier </span><span class="si">%s</span><span class="s"> is used more than once.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;The identifier </span><span class="si">%s</span><span class="s"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
		<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">baseGlyphName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">transformation</span><span class="p">),</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">baseGlyphName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">transformation</span><span class="p">))</span>
		<span class="k">raise</span> <span class="n">warn</span><span class="p">(</span><span class="s">&quot;The addComponent method needs an identifier kwarg. The component&#39;s identifier value has been discarded.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="c"># all formats</span>

<span class="k">def</span> <span class="nf">_validateAndMassagePointStructures</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">pointAttributes</span><span class="p">,</span> <span class="n">openContourOffCurveLeniency</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">children</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">children</span>
	<span class="c"># validate and massage the individual point elements</span>
	<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">subElement</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
		<span class="c"># not &lt;point&gt;</span>
		<span class="k">if</span> <span class="n">subElement</span> <span class="o">!=</span> <span class="s">&quot;point&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown child element (</span><span class="si">%s</span><span class="s">) of contour element.&quot;</span> <span class="o">%</span> <span class="n">subElement</span><span class="p">)</span>
		<span class="c"># unknown attributes</span>
		<span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="n">pointAttributes</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown attributes in point element.&quot;</span><span class="p">)</span>
		<span class="c"># search for unknown children</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dummy</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown child elements in point element.&quot;</span><span class="p">)</span>
		<span class="c"># x and y are required</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;undefined&quot;</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;undefined&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Required x attribute is missing in point element.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Required y attribute is missing in point element.&quot;</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
		<span class="c"># segment type</span>
		<span class="n">segmentType</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="s">&quot;offcurve&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pointTypeOptions</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown point type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">segmentType</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="n">segmentType</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="n">attrs</span><span class="p">[</span><span class="s">&quot;segmentType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segmentType</span>
		<span class="c"># move can only occur as the first point</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;move&quot;</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;A move point occurs after the first point in the contour.&quot;</span><span class="p">)</span>
		<span class="c"># smooth is optional</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;smooth&quot;</span><span class="p">,</span> <span class="s">&quot;no&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">smooth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pointSmoothOptions</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Unknown point smooth value: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">smooth</span><span class="p">)</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">smooth</span> <span class="o">==</span> <span class="s">&quot;yes&quot;</span>
		<span class="n">attrs</span><span class="p">[</span><span class="s">&quot;smooth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth</span>
		<span class="c"># smooth can only be applied to curve and qcurve</span>
		<span class="k">if</span> <span class="n">smooth</span> <span class="ow">and</span> <span class="n">segmentType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;curve&quot;</span><span class="p">,</span> <span class="s">&quot;qcurve&quot;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;smooth attribute set in a </span><span class="si">%s</span><span class="s"> point.&quot;</span> <span class="o">%</span> <span class="n">segmentType</span><span class="p">)</span>
		<span class="c"># name is optional</span>
		<span class="k">if</span> <span class="s">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
	<span class="k">if</span> <span class="n">openContourOffCurveLeniency</span><span class="p">:</span>
		<span class="c"># remove offcurves that precede a move. this is technically illegal,</span>
		<span class="c"># but we let it slide because there are fonts out there in the wild like this.</span>
		<span class="k">if</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s">&quot;segmentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;move&quot;</span><span class="p">:</span>
			<span class="n">children</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
			<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">subElement</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;segmentType&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
						<span class="n">children</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span>
						<span class="k">break</span>
					<span class="k">elif</span> <span class="n">attrs</span><span class="p">[</span><span class="s">&quot;segmentType&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
						<span class="c"># remove the point</span>
						<span class="k">pass</span>
				<span class="k">break</span>
			<span class="n">children</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
	<span class="c"># validate the segments</span>
	<span class="n">pointTypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="s">&quot;offcurve&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
	<span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">pointTypes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;offcurve&quot;</span><span class="p">]):</span>
		<span class="k">while</span> <span class="n">pointTypes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="n">pointTypes</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pointTypes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">pointType</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">pointTypes</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">pointType</span> <span class="o">!=</span> <span class="s">&quot;offcurve&quot;</span><span class="p">:</span>
				<span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pointType</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pointType</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="k">continue</span>
			<span class="n">segmentType</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">offCurves</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
			<span class="c"># move and line can&#39;t be preceded by off-curves</span>
			<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;move&quot;</span><span class="p">:</span>
				<span class="c"># this will have been filtered out already</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;move can not have an offcurve.&quot;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;line&quot;</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;line can not have an offcurve.&quot;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;curve&quot;</span><span class="p">:</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">offCurves</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Too many offcurves defined for curve.&quot;</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;qcurve&quot;</span><span class="p">:</span>
				<span class="k">pass</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c"># unknown segement type. it&#39;ll be caught later.</span>
				<span class="k">pass</span>
	<span class="k">return</span> <span class="n">children</span>

<span class="c"># ---------------------</span>
<span class="c"># Misc Helper Functions</span>
<span class="c"># ---------------------</span>

<span class="k">def</span> <span class="nf">_relaxedSetattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="nb">setattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
		<span class="k">pass</span>

<span class="k">def</span> <span class="nf">_number</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Given a numeric string, return an integer or a float, whichever</span>
<span class="sd">	the string indicates. _number(&quot;1&quot;) will return the integer 1,</span>
<span class="sd">	_number(&quot;1.0&quot;) will return the float 1.0.</span>

<span class="sd">	&gt;&gt;&gt; _number(&quot;1&quot;)</span>
<span class="sd">	1</span>
<span class="sd">	&gt;&gt;&gt; _number(&quot;1.0&quot;)</span>
<span class="sd">	1.0</span>
<span class="sd">	&gt;&gt;&gt; _number(&quot;a&quot;)</span>
<span class="sd">	Traceback (most recent call last):</span>
<span class="sd">	    ...</span>
<span class="sd">	GlifLibError: Could not convert a to an int or float.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;Could not convert </span><span class="si">%s</span><span class="s"> to an int or float.&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

<span class="c"># --------------------</span>
<span class="c"># Rapid Value Fetching</span>
<span class="c"># --------------------</span>

<span class="c"># base</span>

<span class="k">class</span> <span class="nc">_DoneParsing</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">_BaseParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
		<span class="kn">from</span> <span class="nn">xml.parsers.expat</span> <span class="kn">import</span> <span class="n">ParserCreate</span>
		<span class="n">parser</span> <span class="o">=</span> <span class="n">ParserCreate</span><span class="p">()</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">returns_unicode</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># XXX, Don&#39;t remember why. It sucks, though.</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">StartElementHandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startElementHandler</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">EndElementHandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endElementHandler</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">endElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">assert</span> <span class="n">other</span> <span class="o">==</span> <span class="n">name</span>


<span class="c"># unicodes</span>

<span class="k">def</span> <span class="nf">_fetchUnicodes</span><span class="p">(</span><span class="n">glif</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Get a list of unicodes listed in glif.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">_FetchUnicodesParser</span><span class="p">()</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">glif</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">unicodes</span>

<span class="k">class</span> <span class="nc">_FetchUnicodesParser</span><span class="p">(</span><span class="n">_BaseParser</span><span class="p">):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">unicodes</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">_FetchUnicodesParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;unicode&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;glyph&quot;</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;hex&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicodes</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">unicodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
					<span class="k">pass</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">_FetchUnicodesParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">startElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="c"># image</span>

<span class="k">def</span> <span class="nf">_fetchImageFileName</span><span class="p">(</span><span class="n">glif</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The image file name (if any) from glif.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">_FetchImageFileNameParser</span><span class="p">()</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">glif</span><span class="p">)</span>
	<span class="k">except</span> <span class="n">_DoneParsing</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">fileName</span>

<span class="k">class</span> <span class="nc">_FetchImageFileNameParser</span><span class="p">(</span><span class="n">_BaseParser</span><span class="p">):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">_FetchImageFileNameParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;image&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;glyph&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;fileName&quot;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">_DoneParsing</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">_FetchImageFileNameParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">startElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="c"># component references</span>

<span class="k">def</span> <span class="nf">_fetchComponentBases</span><span class="p">(</span><span class="n">glif</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Get a list of component base glyphs listed in glif.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">_FetchComponentBasesParser</span><span class="p">()</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">glif</span><span class="p">)</span>
	<span class="k">except</span> <span class="n">_DoneParsing</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">bases</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_FetchComponentBasesParser</span><span class="p">(</span><span class="n">_BaseParser</span><span class="p">):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">_FetchComponentBasesParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;component&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;outline&quot;</span><span class="p">:</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;base&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">_FetchComponentBasesParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">startElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">endElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;outline&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">_DoneParsing</span>
		<span class="nb">super</span><span class="p">(</span><span class="n">_FetchComponentBasesParser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">endElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="c"># --------------</span>
<span class="c"># GLIF Point Pen</span>
<span class="c"># --------------</span>

<span class="n">_transformationInfo</span> <span class="o">=</span> <span class="p">[</span>
	<span class="c"># field name, default value</span>
	<span class="p">(</span><span class="s">&quot;xScale&quot;</span><span class="p">,</span>    <span class="mi">1</span><span class="p">),</span>
	<span class="p">(</span><span class="s">&quot;xyScale&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
	<span class="p">(</span><span class="s">&quot;yxScale&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
	<span class="p">(</span><span class="s">&quot;yScale&quot;</span><span class="p">,</span>    <span class="mi">1</span><span class="p">),</span>
	<span class="p">(</span><span class="s">&quot;xOffset&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
	<span class="p">(</span><span class="s">&quot;yOffset&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">GLIFPointPen</span><span class="p">(</span><span class="n">AbstractPointPen</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Helper class using the PointPen protocol to write the &lt;outline&gt;</span>
<span class="sd">	part of .glif files.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlWriter</span><span class="p">,</span> <span class="n">formatVersion</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">identifiers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">identifiers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">=</span> <span class="n">formatVersion</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">identifiers</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">xmlWriter</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="k">def</span> <span class="nf">beginPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier not formatted properly: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;identifier&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">begintag</span><span class="p">(</span><span class="s">&quot;contour&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>

	<span class="k">def</span> <span class="nf">endPath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;move&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;offcurve&quot;</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;open contour has loose offcurve point&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">endtag</span><span class="p">(</span><span class="s">&quot;contour&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointType</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="k">def</span> <span class="nf">addPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">segmentType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="c"># coordinates</span>
		<span class="k">if</span> <span class="n">pt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pt</span><span class="p">:</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;coordinates must be int or float&quot;</span><span class="p">)</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
		<span class="c"># segment type</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="n">segmentType</span> <span class="o">=</span> <span class="bp">None</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;move&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;move occurs after a point has already been added to the contour.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;move&quot;</span><span class="p">,</span> <span class="s">&quot;line&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;offcurve occurs before </span><span class="si">%s</span><span class="s"> point.&quot;</span> <span class="o">%</span> <span class="n">segmentType</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;curve&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;too many offcurve points before curve point.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="n">segmentType</span><span class="p">))</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">segmentType</span> <span class="o">=</span> <span class="s">&quot;offcurve&quot;</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segmentType</span><span class="p">)</span>
		<span class="c"># smooth</span>
		<span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">segmentType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;curve&quot;</span><span class="p">,</span> <span class="s">&quot;qcurve&quot;</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;can&#39;t set smooth in a </span><span class="si">%s</span><span class="s"> point.&quot;</span> <span class="o">%</span> <span class="n">segmentType</span><span class="p">)</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;smooth&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">))</span>
		<span class="c"># name</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
		<span class="c"># identifier</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier not formatted properly: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;identifier&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;point&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">addComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;base&quot;</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">)]</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_transformationInfo</span><span class="p">,</span> <span class="n">transformation</span><span class="p">):</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;transformation values must be int or float&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">default</span><span class="p">:</span>
				<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s">&quot;identifier not formatted properly: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;identifier&quot;</span><span class="p">,</span> <span class="n">identifier</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">simpletag</span><span class="p">(</span><span class="s">&quot;component&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">doctest</span>
	<span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">RoboFab 1.3.0a documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../ufoLib.html" >ufoLib</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Tal Leming, Erik van Blokland, Just van Rossum.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.
    </div>
  </body>
</html>